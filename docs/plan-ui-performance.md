<!-- AICODE-NOTE: NAV/UI_PERF_PLAN plan: 80/20 ускорение загрузки UI -->

# План ускорения UI (80/20)

## Цель
Понизить время между кликом по базе и появлением дерева/деталей, минимизируя количество данных/DOM-повторов и делая рендер отзывчивым.

## Scope + non-goals
- **Scope:** уменьшить сетевой payload и рендерную нагрузку при переключении базы, внедрить дебаунс/постепенную загрузку и кэширование отображения без полного перерендера дерева.
- **Non-goals:** переписывание всей архитектуры UI, добавление виртуализации в масштабах всего дерева, глубокие изменения API BaseX.

## 80/20 тактика
1. **Меньше данных:** в `getSections` запрашивать только корневые `Section` (как обсуждали), а детальные ветки подгружать по мере раскрытия; это сокращает payload и работу `DOMParser`.
2. **Клонирование:** убрать лишние глубокие копии (`cloneSections`, `cloneSection`) там, где данные не модифицируются, и разрешить `Navigation` ссылаться на неизменяемые структуры через `Object.freeze`/плоское копирование только при записи.
3. **Рендер дерева:** придерживаться "patch on demand" — при загрузке базы вставлять только top-level DOM, затем рендерить `child nodes` только при раскрытии; заменить `container.innerHTML = ''` на диффинг (например, `DocumentFragment` + предметно-ререндерить).
4. **Отложенные обработчики:** не навешивать обработчики на каждый work/sec при каждом рендере; использовать делегирование через контейнер `#tree-view`, чтобы избежать пересоздания event listeners.
5. **Кэш UI:** сохранять DOM-фрагменты секций/работ в `Map` чтобы при повторном раскрытии не перестраивать элементы (или использовать `requestIdleCallback` для бума).

## Метрики и проверки
- измерять `performance.now()` вокруг `loadSections`/`renderTree`: если время снижается меньше чем на 50 %, признавай оптимизацию эффективной.
- проверять размер запроса в Network (должен упасть благодаря фильтру `ancestor::Section`).
- фиксировать отсутствие ошибок в консоли и живость дерева при кликах/истории.

## Следующие шаги
1. Внедрить быстрый патч `getSections` + `cloneSections` в `navigation.js`.
2. Добавить делегированные обработчики и убрать массовые `addEventListener`.
3. Проверить вручную и через предложенные Playwright-тесты: дерево должно открываться мгновенно.
